{"version":3,"sources":["shareManager.js"],"names":["wxGame","shareManager","load","getShareConfig","console","log","ShareState","isNotAGroupChat","repetitionGroupChat","suscessShare","exShare","failToGetShareTicket","failToShare","userInfoError","shareError","obj","tywx","PropagateInterface","getShareConfigInfo","getRandomShareByPoint","strpoint","shareKeys","ShareConfig","_key","sharePointInfo","length","sharePointId","push","randomIndex","Math","floor","random","sharePointKey","config","title","shareContent","imageUrl","sharePicUrl","shareSchemeId","getShareResultWithKey","informationMap","shareKey","LOGW","openGId","toDay","GlobalFuncs","getCurDay","lastShareTime","ReadStringFromLocalStorage","shareTicketsDic","setInLocalStorage","JSON","stringify","shareTickets","parse","shareList","indexOf","resultType","LOGE","sharePoint","successcallback","failcallback","shareinfo","showToast","extraParam","sendTime","Date","getTime","Global","isOnShare","ShareInterface","share","wx","getShareInfo","shareTicket","success","result","iv","encryptedData","resultString","decrypt","UserInfo","wxgame_session_key","openid","fail","complete","key","crypted","crypto","require","Buffer","decipher","createDecipheriv","decoded","update","final"],"mappings":"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","file":"shareManager.js","sourceRoot":"../../../../../assets/Scripts/common","sourcesContent":["wxGame.shareManager = {\n    load: function () {\n        this.getShareConfig();\n        console.log('load shareConfig')\n    },\n\n    ShareState:{\n        isNotAGroupChat : 1,   //不是群聊\n        repetitionGroupChat : 2,  //重复群聊\n        suscessShare : 3, //正常分享\n        exShare : 4,\n        failToGetShareTicket : 5,\n        failToShare : 6,\n        userInfoError : 7,\n        shareError : 8\n    },\n\n    //从分享营销系统获取配置信息\n    getShareConfig: function () {\n        var obj = {};\n        //获取分享参数\n        tywx.PropagateInterface.getShareConfigInfo(obj);\n    },\n\n    //获取一个分享点\n    //point 必须为3位，类似001  002  003,对应配置系统的后台\n    getRandomShareByPoint: function (strpoint) {\n        var shareKeys = [];\n\n        console.log('getRandomShareByPoint------', strpoint);\n        console.log(tywx.PropagateInterface.ShareConfig);\n        for (var _key in tywx.PropagateInterface.ShareConfig) {\n            var sharePointInfo = tywx.PropagateInterface.ShareConfig[_key];\n            if (sharePointInfo && sharePointInfo.length > 0) {\n                if (sharePointInfo[0].sharePointId == strpoint) {\n                    shareKeys.push(_key);\n                    console.log('_key');\n                }\n            }\n        }\n\n        if (shareKeys && shareKeys.length > 0) {\n            var randomIndex = (Math.floor(Math.random() * 10000)) % shareKeys.length;\n            var sharePointKey = shareKeys[randomIndex];\n            var sharePointInfo = tywx.PropagateInterface.ShareConfig[sharePointKey];\n            if (sharePointInfo && sharePointInfo.length > 0) {\n                randomIndex = (Math.floor(Math.random() * 10000)) % sharePointInfo.length;\n                var config = {\n                    title: sharePointInfo[randomIndex].shareContent,\n                    imageUrl: sharePointInfo[randomIndex].sharePicUrl,\n                    sharePointId: sharePointInfo[randomIndex].sharePointId,\n                    shareSchemeId: sharePointInfo[randomIndex].shareSchemeId\n                };\n                return config;\n            }\n        }\n        return null;\n    },\n\n    //存储分享数据\n    getShareResultWithKey:function(informationMap,shareKey){\n        wxGame.LOGW(\"file = [shareManager] fun = [getShareResultWithKey]\");\n        var openGId = informationMap.openGId;\n        var toDay = wxGame.GlobalFuncs.getCurDay();\n        var lastShareTime = wxGame.GlobalFuncs.ReadStringFromLocalStorage(\"LAST_SHARE_TIME\", \"\");\n        var shareTicketsDic = {};\n        if(toDay != lastShareTime){\n            shareTicketsDic[shareKey] = [openGId];\n            wxGame.GlobalFuncs.setInLocalStorage(\"SHARETICKETS_LIST\", JSON.stringify(shareTicketsDic));\n            wxGame.GlobalFuncs.setInLocalStorage(\"LAST_SHARE_TIME\", toDay);\n        }else {\n            var shareTickets = wxGame.GlobalFuncs.ReadStringFromLocalStorage(\"SHARETICKETS_LIST\", \"\");\n            shareTicketsDic = JSON.parse(shareTickets);\n            if(shareTicketsDic && shareTicketsDic[shareKey] && shareTicketsDic[shareKey].length){\n                var shareList = shareTicketsDic[shareKey];\n                if (shareList.indexOf(openGId) > -1){\n                    wxGame.shareManager.resultType = wxGame.shareManager.ShareState.repetitionGroupChat;\n                    wxGame.LOGE(\"file = [shareManager] fun = [getShareResultWithKey] 重复群\");\n                    return;\n                }\n                shareList.push(openGId);\n                wxGame.GlobalFuncs.setInLocalStorage(\"SHARETICKETS_LIST\", JSON.stringify(shareTicketsDic));\n            }else {\n                shareTicketsDic[shareKey] = [openGId];\n                wxGame.GlobalFuncs.setInLocalStorage(\"SHARETICKETS_LIST\", JSON.stringify(shareTicketsDic));\n            }\n        }\n        wxGame.LOGE(\"file = [shareManager] fun = [getShareResultWithKey] 成功\");\n        wxGame.shareManager.resultType = wxGame.shareManager.ShareState.suscessShare;\n    },\n\n    sharePoint: function (strpoint, successcallback, failcallback) {\n        var shareinfo = this.getRandomShareByPoint(strpoint);\n        if (!shareinfo) {\n            wxGame.GlobalFuncs.showToast(\"数据获取失败~\");\n        }\n        var extraParam = {\n            sendTime: (new Date()).getTime()\n        };\n        console.log(\"getRandomShareByPoint return : \", shareinfo, extraParam);\n        wxGame.LOGW(\"file = [shareManager] fun = [sharePoint] strpoint = \" + strpoint);\n        if (shareinfo == null) {\n            if (failcallback) {\n                wxGame.LOGW(\"file = [shareManager] fun = [sharePoint] return\");\n                failcallback('fail');\n            }\n            return;\n        }\n\n        wxGame.shareManager.resultType = 0;\n        wxGame.Global.isOnShare = true;\n        wxGame.Global.sharePoint = strpoint;\n        tywx.ShareInterface.share(shareinfo.title, shareinfo.imageUrl, shareinfo.sharePointId, shareinfo.shareSchemeId, function(obj) {\n            console.log('sharecomplete:');\n            console.log(obj);\n            if (!(obj.shareTickets && obj.shareTickets.length > 0)) {\n                wxGame.shareManager.resultType = wxGame.shareManager.ShareState.isNotAGroupChat;\n                if (failcallback) {\n                    failcallback('fail');\n                }\n                return;\n            }\n            wx.getShareInfo({\n                shareTicket: obj.shareTickets[0],\n                success: function (result) {\n                    if (result) {\n                        //判断秘钥是否有用\n                        var iv = result.iv;\n                        var encryptedData = result.encryptedData;\n                        // try {\n                            var resultString = wxGame.shareManager.decrypt(tywx.UserInfo.wxgame_session_key, iv, encryptedData);\n                            console.log(resultString);\n                            wxGame.LOGW(\"file = [shareManager] fun = [sharePoint] resultString: = \" + JSON.stringify(resultString));\n                            if (resultString) {\n                                resultString = JSON.parse(resultString);\n                                wxGame.shareManager.getShareResultWithKey(resultString,strpoint);\n                                var openid = '';\n                                // 分享\n                                if (resultString.openGId) {\n                                    openid = resultString.openGId;\n                                }\n                                wxGame.LOGW(\"file = [shareManager] fun = [sharePoint] 分享群ID: = \" + JSON.stringify(openid));\n                                if (successcallback != null) {\n                                    successcallback(openid, obj.shareTickets[0]);\n                                }\n\n                            } else {\n                                if (failcallback) {\n                                    failcallback();\n                                }\n                            }\n                        // } catch (error) {\n                        //     wxGame.LOGW(\"file = [shareManager] fun = [sharePoint] error = \" + JSON.stringify(error));\n                        //     if (successcallback != null) {\n                        //         successcallback(obj.shareTickets[0], obj.shareTickets[0]);\n                        //     }\n                        // }\n                    }\n                },\n                fail: function() {\n                    wxGame.LOGW(\"file = [shareManager] fun = [sharePoint] getUserInfo  fail: \");\n                    if (failcallback) {\n                        failcallback('cancel');\n                    }\n                    wxGame.shareManager.resultType = wxGame.shareManager.ShareState.failToGetShareTicket;\n                },\n                complete: function()  {\n                    // if (failcallback) {\n                    //     failcallback();\n                    // }\n                },\n            })\n        }, failcallback, extraParam);\n    },\n\n    decrypt: function (key, iv, crypted) {\n        var crypto = require('crypto');\n\n        crypted = new Buffer(crypted, 'base64');\n        iv = new Buffer(iv, 'base64');\n        key = new Buffer(key, 'base64');\n        var decipher = crypto.createDecipheriv('aes-128-cbc', key, iv);\n        var decoded = decipher.update(crypted, 'binary', 'utf8');\n        decoded += decipher.final('utf8');\n        return decoded;\n    },\n\n};"]}
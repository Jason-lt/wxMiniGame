{"version":3,"sources":["AdManager.js"],"names":["tywx","AdManager","adIconBtn","adInfoList","currentAdInfo","currentWebPage","retryTimes","requestADInfo","IsWechatPlatform","reqObj","timeStamp","Date","getTime","act","time","game_mark","SystemInfo","cloudId","gameId","signStr","getConfigSignStr","paramStrList","key","push","finalUrl","shareManagerUrl","join","that","wx","request","url","method","success","res","statusCode","ret","data","console","log","JSON","stringify","retmsg","index","fail","showAd","position","genRandomFirstAdInfo","active","cc","loader","loadRes","err","prefab","preFabNode","instantiate","p","x","y","game","addPersistRootNode","load","icon_url","texture","spriteIco","getChildByName","getComponent","Sprite","spriteFrame","SpriteFrame","adButton","on","BiLog","clickStat","clickStatEventType","clickStatEventTypeClickFirstAd","icon_name","onClickAdIconBtn","length","weight_list","i","parseInt","icon_weight","sort","a","b","total","forEach","element","_randomIndex","Math","random","_tTotal","_selectIndex","_selectNum","toString","genRandomSecondAdInfo","_webPages","webpages","webpage_weight","hideAd","webpage_url","config_id","previewImage","current","urls","LOGD","resetBtnIcon","sortedKeys","Object","keys","finalSign","hex_md5"],"mappings":"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","file":"AdManager.js","sourceRoot":"../../../../../assets/Scripts/CommonFrame","sourcesContent":["/**\n * Created by xiaochuntian on 2018/5/31.\n */\n\n/**\n * 交叉导流相关系统接口, 调用导流接口使用showAd 接口， 刷新导流显示icon使用resetBtnIcon 接口\n */\ntywx.AdManager = {\n    adIconBtn: null,                //向其他小游戏的导流入口\n\n    adInfoList : [],                //所有广告信息的列表\n    currentAdInfo : null,           //当前做展示的导流信息\n    currentWebPage : null,          //当前显示的最终导流游戏的信息\n    retryTimes : 3,                 //网络请求失败重试次数\n\n    /**\n     * 请求交叉倒流的信息\n     */\n    requestADInfo : function () {\n\n        if(!tywx.IsWechatPlatform()) {\n            return;\n        }\n        this.retryTimes--;\n        var reqObj = {};\n        var timeStamp = new Date().getTime();\n        reqObj.act = 'api.getCrossConfig';\n        reqObj.time = timeStamp;\n        reqObj.game_mark = tywx.SystemInfo.cloudId + \"-\" + tywx.SystemInfo.gameId;\n        var signStr = this.getConfigSignStr(reqObj);\n        var paramStrList = [];\n        for(var key in reqObj) {\n            paramStrList.push(key + '=' + reqObj[key]);\n        }\n        paramStrList.push('sign=' + signStr);\n        var finalUrl = tywx.SystemInfo.shareManagerUrl + '?' + paramStrList.join('&');\n        var that = this;\n\n        wx.request({\n            url : finalUrl,\n            method : 'GET',\n            success : function (res) {\n                if (res.statusCode == 200){\n\n                    var ret = res.data;\n                    console.log('RET:' + JSON.stringify(ret));\n                    that.adInfoList = [];\n                    if(ret.retmsg){\n                        for(var index in ret.retmsg){\n                            that.adInfoList.push(ret.retmsg[index]);\n                        }\n                    }\n\n                    that.retryTimes = 3;\n                }\n            },\n            fail : function (res) {\n\n                if(that.retryTimes > 0){\n\n                    that.requestADInfo();\n                }else{\n                    that.retryTimes = 0;\n                }\n\n            }\n        });\n\n\n    },\n\n    /**\n     * 对外接口，用于添加广告位\n     * position {x, y}\n     */\n    showAd: function(position) {\n\n        this.genRandomFirstAdInfo();\n\n        if(!this.currentAdInfo){\n            return;\n        }\n\n        if(this.adIconBtn) {\n            this.adIconBtn.active = true;\n        } else {\n            var that = this;\n            //动态加载资源必须放在resources目录下,导流入口强制命名为adNode,放在resources/prefabs下\n            cc.loader.loadRes('prefabs/adNode', function (err, prefab) {\n                var preFabNode = cc.instantiate(prefab);\n                preFabNode.position = cc.p(position.x, position.y);\n                that.adIconBtn = preFabNode;\n                cc.game.addPersistRootNode(preFabNode);\n\n                cc.loader.load({url: that.currentAdInfo.icon_url}, function (err, texture) {\n                    if (!err) {\n                        var spriteIco = preFabNode.getChildByName('adIcon');\n                        spriteIco.getComponent(cc.Sprite).spriteFrame = new cc.SpriteFrame(texture);\n                        var adButton = preFabNode.getChildByName('adButton');\n                        adButton.on('click', function () {\n                            tywx.BiLog.clickStat(tywx.clickStatEventType.clickStatEventTypeClickFirstAd, [that.currentAdInfo.icon_url, that.currentAdInfo.icon_name]);\n                            that.onClickAdIconBtn();\n                        });\n                    }\n                    else {\n                        //加载失败\n                    }\n                });\n            });\n        }\n    },\n\n    /**\n     * 生成随机的一级导流信息\n     */\n    genRandomFirstAdInfo : function() {\n\n        if(this.adInfoList.length == 0){\n            return;\n        }\n\n        var weight_list = [0];\n\n        for(var i in this.adInfoList){\n            weight_list.push(parseInt(this.adInfoList[i].icon_weight));\n        }\n\n        weight_list.sort(function(a, b){\n            return a > b;\n        });\n\n        var total = 0;\n\n        weight_list.forEach(element => {\n            total += element;\n    });\n\n        var _randomIndex = parseInt(Math.random()*10000)%(total+1);\n\n        var _tTotal = 0;\n\n        var _selectIndex = 0;\n        for(var i=0; i<(weight_list.length-1);i++){\n            _tTotal += weight_list[i];\n            if(_tTotal < _randomIndex && (_tTotal+weight_list[i+1]) >= _randomIndex){\n                _selectIndex = i+1;\n                break;\n            }\n        }\n        var _selectNum = weight_list[_selectIndex];\n\n        this.adInfoList.forEach(element => {\n            if(element.icon_weight == _selectNum.toString()){\n            this.currentAdInfo = element;\n        }\n    });\n\n    },\n\n    /**\n     * 生成随机的二级导流信息\n     */\n    genRandomSecondAdInfo : function() {\n\n        var _webPages = this.currentAdInfo.webpages;\n\n        if(_webPages.length == 0){\n            return;\n        }\n\n        var weight_list = [0];\n\n        for(var i in _webPages){\n            weight_list.push(parseInt(_webPages[i].webpage_weight));\n        }\n\n        weight_list.sort(function(a, b){\n            return a > b;\n        });\n\n        var total = 0;\n\n        weight_list.forEach(element => {\n            total += element;\n    });\n\n        var _randomIndex = parseInt(Math.random()*10000)%(total+1);\n\n        var _tTotal = 0;\n\n        var _selectIndex = 0;\n        for(var i=0; i<(weight_list.length-1);i++){\n            _tTotal += weight_list[i];\n            if(_tTotal < _randomIndex && (_tTotal+weight_list[i+1]) >= _randomIndex){\n                _selectIndex = i+1;\n                break;\n            }\n        }\n        var _selectNum = weight_list[_selectIndex];\n\n        _webPages.forEach(element => {\n            if(element.webpage_weight.toString() == _selectNum.toString()){\n            this.currentWebPage = element;\n        }\n    });\n\n        console.log('this.currentWebPage' + JSON.stringify(this.currentWebPage));\n    },\n\n    hideAd: function() {\n        if(this.adIconBtn) {\n            this.adIconBtn.active = false;\n        }\n    },\n\n    onClickAdIconBtn: function() {\n        this.genRandomSecondAdInfo();\n\n        if(!this.currentWebPage){\n            return;\n        }\n\n        var that = this;\n        tywx.BiLog.clickStat(tywx.clickStatEventType.clickStatEventTypeClickFirstAd, [that.currentWebPage.webpage_url, that.currentAdInfo.config_id]);\n\n        if(tywx.IsWechatPlatform()) {\n            wx.previewImage({\n                current: [that.currentWebPage.webpage_url],\n                urls: [that.currentWebPage.webpage_url],\n                success:function(res){\n                    tywx.LOGD(null, \"预览图片成功！\");\n                },\n                fail:function (res) {\n                    tywx.LOGD(null, \"预览图片失败！\");\n                }\n            });\n        }\n\n        this.resetBtnIcon();\n    },\n\n    /**\n     * 刷新ad按钮的icon\n     */\n    resetBtnIcon : function() {\n\n        var that = this;\n\n        this.genRandomFirstAdInfo();\n        if(!that.adIconBtn || !that.currentAdInfo.icon_url){\n            return;\n        }\n\n        cc.loader.load({url: that.currentAdInfo.icon_url}, function (err, texture) {\n            if (!err) {\n                var spriteIco = that.adIconBtn.getChildByName('adIcon');\n                spriteIco.getComponent(cc.Sprite).spriteFrame = new cc.SpriteFrame(texture);\n\n            }\n        });\n\n    },\n\n    /**\n     * 计算签名字符串\n     * @param reqObj\n     * @returns {string}\n     */\n    getConfigSignStr: function(reqObj) {\n        var sortedKeys = Object.keys(reqObj).sort();\n        var signStr = '';\n        for(var i=0;i<sortedKeys.length;i++){\n            var key = sortedKeys[i];\n            if(key == 'act' || key == 'sign') {\n                continue;\n            } else {\n                signStr += key + '=' + reqObj[key];\n            }\n        }\n        var finalSign = tywx.hex_md5('market.tuyoo.com-api-' + signStr + '-market.tuyoo-api') || '';\n        return finalSign;\n    },\n};\n\ntywx.AdManager.requestADInfo();"]}
{"version":3,"sources":["../../../../../assets/Scripts/common/assets/Scripts/common/shareManager.js"],"names":["shareManager","load","getShareConfig","console","log","obj","tywx","PropagateInterface","getShareConfigInfo","getRandomShareByPoint","strpoint","shareKeys","ShareConfig","_key","sharePointInfo","length","sharePointId","push","randomIndex","Math","floor","random","sharePointKey","config","title","shareContent","imageUrl","sharePicUrl","shareSchemeId","sharePoint","successcallback","failcallback","extraParam","shareinfo","ShareInterface","share","shareTickets","wx","getShareInfo","shareTicket","success","result","iv","encryptedData","resultString","Global","decrypt","UserInfo","wxgame_session_key","JSON","parse","openid","openGId","error","fail","complete","key","crypted","crypto","require","Buffer","decipher","createDecipheriv","decoded","update","final","module","exports"],"mappings":"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","file":"shareManager.js","sourceRoot":"../../../../../assets/Scripts/common","sourcesContent":["var shareManager = {\n    load: function () {\n        this.getShareConfig();\n        console.log('load shareConfig')\n    },\n\n    //从分享营销系统获取配置信息\n    getShareConfig: function () {\n        let obj = {};\n        //获取分享参数\n        tywx.PropagateInterface.getShareConfigInfo(obj);\n    },\n\n    //获取一个分享点\n    //point 必须为3位，类似001  002  003,对应配置系统的后台\n    getRandomShareByPoint: function (strpoint) {\n        var shareKeys = [];\n\n        console.log('getRandomShareByPoint------', strpoint);\n        console.log(tywx.PropagateInterface.ShareConfig);\n        for (var _key in tywx.PropagateInterface.ShareConfig) {\n            let sharePointInfo = tywx.PropagateInterface.ShareConfig[_key];\n            if (sharePointInfo && sharePointInfo.length > 0) {\n                if (sharePointInfo[0].sharePointId == strpoint) {\n                    shareKeys.push(_key);\n                    console.log('_key');\n                }\n            }\n        }\n\n        if (shareKeys && shareKeys.length > 0) {\n            var randomIndex = (Math.floor(Math.random() * 10000)) % shareKeys.length;\n            var sharePointKey = shareKeys[randomIndex];\n            var sharePointInfo = tywx.PropagateInterface.ShareConfig[sharePointKey];\n            if (sharePointInfo && sharePointInfo.length > 0) {\n                randomIndex = (Math.floor(Math.random() * 10000)) % sharePointInfo.length;\n                var config = {\n                    title: sharePointInfo[randomIndex].shareContent,\n                    imageUrl: sharePointInfo[randomIndex].sharePicUrl,\n                    sharePointId: sharePointInfo[randomIndex].sharePointId,\n                    shareSchemeId: sharePointInfo[randomIndex].shareSchemeId\n                }\n                return config;\n            }\n        }\n        return null;\n    },\n\n    sharePoint: function (strpoint, successcallback, failcallback, extraParam) {\n        let shareinfo = this.getRandomShareByPoint(strpoint);\n        console.log(\"getRandomShareByPoint return : \", shareinfo, extraParam);\n        if (shareinfo == null) {\n            if (failcallback) {\n                failcallback('fail');\n            }\n            return;\n        }\n        tywx.ShareInterface.share(shareinfo.title, shareinfo.imageUrl, shareinfo.sharePointId, shareinfo.shareSchemeId, (obj) => {\n            console.log('sharecomplete:');\n            console.log(obj);\n            if (!(obj.shareTickets && obj.shareTickets.length > 0)) {\n                if (failcallback) {\n                    failcallback('fail');\n                }\n                return;\n            }\n            wx.getShareInfo({\n                shareTicket: obj.shareTickets[0],\n                success: function (result) {\n                    if (result) {\n                        //判断秘钥是否有用\n                        var iv = result.iv;\n                        var encryptedData = result.encryptedData;\n                        try {\n                            var resultString = Global.shareManager.decrypt(tywx.UserInfo.wxgame_session_key, iv, encryptedData);\n                            console.log(resultString);\n                            if (resultString) {\n                                resultString = JSON.parse(resultString);\n                                let openid = '';\n                                // 分享\n                                if (resultString.openGId) {\n                                    openid = resultString.openGId;\n                                }\n                                console.log('分享群ID:', successcallback, openid);\n                                if (successcallback != null) {\n                                    successcallback(openid, obj.shareTickets[0]);\n                                }\n                            } else {\n                                if (failcallback) {\n                                    failcallback();\n                                }\n                            }\n                        } catch (error) {\n                            console.log('分享出异常了*****', obj.shareTickets[0]);\n                            if (successcallback != null) {\n                                successcallback(obj.shareTickets[0], obj.shareTickets[0]);\n                            }\n                        }\n                    }\n                },\n                fail: () => {\n                    if (failcallback) {\n                        failcallback('cancel');\n                    }\n                },\n                complete: () => {\n                    // if (failcallback) {\n                    //     failcallback();\n                    // }\n                },\n            })\n        }, failcallback, extraParam);\n    },\n\n    decrypt: function (key, iv, crypted) {\n        var crypto = require('crypto');\n\n        crypted = new Buffer(crypted, 'base64');\n        iv = new Buffer(iv, 'base64');\n        key = new Buffer(key, 'base64');\n        var decipher = crypto.createDecipheriv('aes-128-cbc', key, iv);\n        var decoded = decipher.update(crypted, 'binary', 'utf8');\n        decoded += decipher.final('utf8');\n        return decoded;\n    },\n\n};\nshareManager.load();\nmodule.exports = shareManager;"]}
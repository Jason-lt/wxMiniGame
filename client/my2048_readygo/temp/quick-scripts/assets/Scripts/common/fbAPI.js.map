{"version":3,"sources":["fbAPI.js"],"names":["FBGlobal","fbname","fbphoto","fbScore","crystal","debugText","getFBScore","callback","FBInstant","player","getName","getPhoto","getDataAsync","then","data","catch","error","code","message","saveFBScore","maxScore","parseInt","setDataAsync","maxscore","strNameAndPhoto","getLeaderboardAsync","leaderboard","setScoreAsync","getRank","result","getEntriesAsync","entries","length","onShareGame","img","shareAsync","intent","image","text","myReplayData","onChallenge","module","exports"],"mappings":"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","file":"fbAPI.js","sourceRoot":"../../../../../assets/Scripts/common","sourcesContent":["var FBGlobal = {\n    fbname : 'noname',\n    fbphoto : null,\n    fbScore: 0,\n    crystal: 0,\n    debugText: 'FB api loaded',\n\n    getFBScore: function (callback) {\n        FBGlobal.debugText = 'called getFBScore() ';\n        if (typeof FBInstant === 'undefined') return;\n\n        FBGlobal.fbname = FBInstant.player.getName();\n        FBGlobal.fbphoto = FBInstant.player.getPhoto();\n        FBGlobal.debugText = 'try get score from fb ';\n        FBInstant.player.getDataAsync(['maxscore'])\n            .then(data => {\n                FBGlobal.fbScore = data['maxscore'] || 0;\n                FBGlobal.crystal = data['crystal'] || 0;\n                if (callback) {\n                    callback(FBGlobal.fbScore, FBGlobal.crystal);\n                }\n                FBGlobal.debugText = ' get score from fb :' + FBGlobal.fbScore + ' crystal:' + FBGlobal.crystal;\n            })\n            .catch(error => {\n                FBGlobal.debugText = ' getDataAsysnc error\\n code:' + error.code + '\\n msg: ' + error.message;\n            });\n        // return FBGlobal.fbScore;\n    },\n\n    saveFBScore: function (maxScore,crystal) {\n        FBGlobal.debugText = 'called saveFBScore() ';\n        if (!maxScore) {\n\n            FBGlobal.debugText = 'params maxScore not exists,return';\n            return;\n        }\n        if (!FBGlobal.fbScore) {\n            FBGlobal.debugText = 'FBGlobal.fbScore not exists,return';\n            FBGlobal.fbScore = 0;\n        } \n        maxScore = parseInt(maxScore)\n        FBGlobal.debugText = 'saveFBScore :' + maxScore;\n        if (typeof FBInstant === 'undefined') return;\n\n        if (maxScore > FBGlobal.fbScore) {\n            FBGlobal.debugText = 'try save score to fb :' + maxScore;\n            FBInstant.player.setDataAsync({\n                maxscore: maxScore,\n                crystal: crystal\n            })\n                .then(() => {\n                    FBGlobal.fbScore = maxScore;\n                    FBGlobal.debugText = ' save score to fb player successed';\n                })\n                .catch(error => {\n                    FBGlobal.debugText = ' setDataAsync error\\n code:' + error.code + '\\n msg: ' + error.message;\n                });\n\n            var strNameAndPhoto = FBGlobal.fbname + '_' + FBGlobal.fbphoto;\n            //更新排行榜\n            FBInstant.getLeaderboardAsync('my_linerank')\n                .then(leaderboard => {\n                    FBGlobal.debugText = ' save score to fb successed on setScoreAsync';\n                    return leaderboard.setScoreAsync(maxScore, strNameAndPhoto);\n                })\n                .then(entry => {\n                    FBGlobal.debugText = ' save score to fb successed get entry';\n                })\n                .catch(error => {\n                    FBGlobal.debugText = ' save score to fb rank error setScoreAsync\\n code:' + error.code + '\\n msg: ' + error.message;\n                });\n        } else {\n\n            FBGlobal.debugText = 'not saved ,old highscore is :' + FBGlobal.fbScore;\n        }\n    },\n\n    getRank: function (callback) {\n        FBGlobal.debugText = 'called getRank()';\n        if (typeof FBInstant === 'undefined') return;\n        var result = null;\n        FBGlobal.debugText = 'try get fb rank';\n        FBInstant.getLeaderboardAsync('my_linerank')\n            .then(leaderboard => {\n                FBGlobal.debugText = ' get fb rank leaderboard';\n                return leaderboard.getEntriesAsync();\n            })\n            .then(entries => {\n                if (entries) {\n                    FBGlobal.debugText = ' get fb rank entries :' + entries.length;\n                } else {\n                    FBGlobal.debugText = ' no entries ';\n                }\n                if (callback) {\n                    callback(entries);\n                }\n            })\n            .catch(error => {\n                FBGlobal.debugText = \"getLeaderboardAsync error\\n code:\" + error.code + '\\n msg:' + error.message;\n            });\n    },\n\n    // 分享功能  intent(\"INVITE\" | \"REQUEST\" | \"CHALLENGE\" | \"SHARE\") 表示分享的意图\n    onShareGame: function (img) {\n        FBGlobal.debugText = 'called onShareGame()';\n        if (!img) {\n            return;\n        }\n        FBGlobal.debugText = 'get screenshot :' + img.length;\n        if (typeof FBInstant === 'undefined') return;\n\n        // 分享功能  intent(\"INVITE\" | \"REQUEST\" | \"CHALLENGE\" | \"SHARE\") 表示分享的意图\n        // var img = this.getImgBase64(w, h, renderType);\n        // FBGlobal.debugText = 'get screenshot :' + img.length;\n        FBInstant.shareAsync({\n            intent: 'SHARE',\n            image: img,\n            text: 'Look my score!',\n            data: {\n                myReplayData: '...'\n            },\n        }).then(() => {\n            // continue with the game.\n        })\n        .catch(error => {\n            FBGlobal.debugText = ' shareAsync error\\n code:' + error.code + '\\n msg: ' + error.message;\n        });\n    },\n\n    onChallenge: function (img) {\n        FBGlobal.debugText = 'called onChallenge()';\n        if (!img) {\n            return;\n        }\n        FBGlobal.debugText = 'get screenshot :' + img.length;\n        if (typeof FBInstant === 'undefined') return;\n        FBInstant.shareAsync({\n            intent: 'INVITE',\n            image: img,\n            text: 'I just challenged Watermelon ,Join me!',\n            data: {\n                myReplayData: '...'\n            },\n        }).then(() => {\n            // continue with the game.\n        })\n        .catch(error => {\n            FBGlobal.debugText = ' challenge shareAsync\\n code:' + error.code + '\\n msg: ' + error.message;\n        });\n    },\n\n    \n\n\n    // 截屏返回 iamge base6，用于 Share\n    // 需要传入屏幕宽高和渲染模式\n    // 需把该方法复制到cc.component中执行.\n    // getImgBase64: function () {\n    //     var target = cc.find('Canvas');\n    //     this.gameinfo.debuglabel.string = \"w,h:\" + target.width + ',' + target.height;\n    //     var width = parseInt(target.width),\n    //         height = parseInt(target.height);\n    //     var renderTexture = new cc.RenderTexture(width, height);\n    //     renderTexture.begin();\n    //     target._sgNode.visit();\n    //     renderTexture.end();\n    //     //\n    //     var canvas = document.createElement('canvas');\n    //     var ctx = canvas.getContext('2d');\n    //     canvas.width = width;\n    //     canvas.height = height;\n\n    //     if (cc._renderType === cc.game.RENDER_TYPE_CANVAS) {\n    //         var texture = renderTexture.getSprite().getTexture();\n    //         var image = texture.getHtmlElementObj();\n    //         ctx.drawImage(image, 0, 0);\n    //     } else if (cc._renderType === cc.game.RENDER_TYPE_WEBGL) {\n    //         var buffer = gl.createFramebuffer();\n    //         gl.bindFramebuffer(gl.FRAMEBUFFER, buffer);\n    //         var texture = renderTexture.getSprite().getTexture()._glID;\n    //         gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\n    //         var data = new Uint8Array(width * height * 4);\n    //         gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, data);\n    //         gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n    //         var rowBytes = width * 4;\n    //         for (var row = 0; row < height; row++) {\n    //             var srow = height - 1 - row;\n    //             var data2 = new Uint8ClampedArray(data.buffer, srow * width * 4, rowBytes);\n    //             var imageData = new ImageData(data2, width, 1);\n    //             ctx.putImageData(imageData, 0, row);\n    //         }\n    //     }\n    //     // cc.log('to share');\n    //     return canvas.toDataURL('image/png');\n    // },\n}\n\nmodule.exports = FBGlobal;\n"]}
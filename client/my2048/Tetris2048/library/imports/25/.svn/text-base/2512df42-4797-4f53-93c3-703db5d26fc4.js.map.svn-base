{"version":3,"sources":["../../../../../assets/Scripts/view/assets/Scripts/view/gridView.js"],"names":["cc","Class","extends","Component","properties","combineAudio","url","AudioClip","default","numPrefab","type","Prefab","goldPrefab","combineID","allGrids","hIndex","vIndex","item","gridNum","targetGrid","Node","isDown","moveIndex","sameScoreNum","deleteGrids","isJoin","actionJoin","joinItems","setIndex","gridController","startBianli","self","gridControllerScript","Global","getComponent","bianliForGrid","startJoin","length","changeScore","console","log","extraNum","combineTimes","doubleNum","usePropStatus","cdnGameConfig","totalSwith","currTime","Date","getTime","wxScore","newUserScore","popDialogTimes","newUserPropCd","newUserEquals","indexOf","game","showPropDialog","random","Math","popPropTotalTimes","weightRate","scoreEquals","scoreScript","addScore","itemViewScript","bornNum","updateNum","updateColor","playFlyNum","playFlyGold","flyIndex","canFlyNums","parseInt","numInstance","instantiate","setNum","setPosition","p","node","getPosition","x","y","parent","addChild","toPosition","canFlyGolds","goldInstance","goldNode","gridViewScript","bianliHIndex","bianliVIndex","hasSameScore","hNum","vNum","compareGrid","compareGridScript","compareItem","useClear","gridMaxScore","gridScript","push","index","deleteGrid","deleteGridScript","deleteItem","useDouble","toJoin","resetData","check","runAction","sequence","delayTime","callFunc","checkJoinComplete","isComplete","curState","playCombineAudio","isBGMPlaying","audioEngine","play","setFinishCallback","playAudioEnd","playAudioStart","resume","uncache"],"mappings":"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","file":"gridView.js","sourceRoot":"../../../../../assets/Scripts/view","sourcesContent":["/*\n    合并触发判断，递归\n*/\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        combineAudio: {\n            url: cc.AudioClip,\n            default: null\n        },\n\n        numPrefab: {\n            default: null,\n            type: cc.Prefab,\n        },\n        goldPrefab: {\n            default: null,\n            type: cc.Prefab,\n        },\n        combineID: 0,\n        allGrids: null, //所有的格子信息\n        hIndex: 0,\n        vIndex: 0,\n        item: null,\n\n        //格子上的分数\n        gridNum: 0, //2  4 8  16\n\n        //目标格子\n        targetGrid: {\n            default: null,\n            type: cc.Node\n        },\n\n        isDown: false, //是否是下落的格子\n\n        moveIndex: 0, //下方的格子被消灭后，移动的距离\n        sameScoreNum: 0, //合并时记录相同的分数格子数量\n\n        deleteGrids: [], //存储即将合并的格子\n        isJoin: false,\n        actionJoin: false,\n        joinItems: [],\n    },\n\n    //设置索引index\n    setIndex: function (hIndex, vIndex, gridController) {\n        this.hIndex = hIndex;\n        this.vIndex = vIndex;\n    },\n\n    //开始遍历\n    startBianli: function () {\n        var self = this;\n        this.joinItems = [];\n\n        var gridControllerScript = Global.gridController.getComponent(\"gridController\");\n        this.allGrids = gridControllerScript.allGrids;\n        //将要合并的数组\n        this.deleteGrids = [];\n\n        this.bianliForGrid();\n        //开始执行合并动作\n        this.startJoin();\n        //改变分数\n        this.isDown = false;\n\n        return (this.joinItems.length > 0);\n    },\n\n    //改变分数\n    changeScore: function () {\n        let self = this;\n        var gridControllerScript = Global.gridController.getComponent(\"gridController\");\n        self.isDown = false;\n        //改变分数\n        if (self.deleteGrids.length > 0) {\n            if (self.deleteGrids.length == 1) {\n                self.gridNum *= 2;\n            } else if (self.deleteGrids.length == 2) {\n                self.gridNum *= 4;\n            } else if (self.deleteGrids.length == 3) {\n                self.gridNum *= 8;\n            }\n\n            //弹出宝箱分享弹框\n            /*if (self.deleteGrids.length >= 2) {\n                var random = Math.random();\n                console.log('随机宝箱的概率：' + random);\n                if (!Global.propInfoUI && random <= Global.randomChestWeight) {\n                    Global.game.showPropDialog(true);\n                }\n            }*/\n\n            //combine加分\n            console.log('连击之前的分数：' + self.gridNum);\n            var extraNum = 0;\n            if (Global.combineTimes > 0) {\n                if (Global.combineTimes > 4) {\n                    Global.combineTimes = 4;\n                }\n                /*\n                if (Global.combineTimes > 1) {\n                    //合并数大于2\n                    console.log('删除的格子数量：' + self.deleteGrids.length);\n                    if (self.deleteGrids.length > 1) {\n                        Global.combineTimes = self.deleteGrids.length + 1;\n                    }\n                }*/\n                extraNum = (Global.combineTimes - 1) * self.gridNum;\n                console.log('连击加的分数：' + extraNum);\n            }\n            console.log('连击之后的分数：' + (self.gridNum + extraNum));\n\n            var doubleNum = 0;\n            if (Global.usePropStatus == 2) {\n                console.log('使用了双倍道具,加分之前的分数：', self.gridNum + extraNum);\n                doubleNum = self.gridNum * (2 - 1);\n                console.log('双倍道具使用之后的分数:' + self.gridNum + extraNum + doubleNum);\n                Global.usePropStatus = -1;\n            }\n\n            if (self.gridNum > 4096) {\n                self.gridNum = 4096;\n            }\n\n            //弹出道具分享\n            if (!Global.cdnGameConfig.totalSwith) {\n                var currTime = (new Date()).getTime();\n                if (Global.wxScore < Global.cdnGameConfig.newUserScore) {\n                    if ((currTime - gridControllerScript.popDialogTimes) > Global.cdnGameConfig.newUserPropCd) {\n                        if (Global.cdnGameConfig.newUserEquals && Global.cdnGameConfig.newUserEquals.indexOf(self.gridNum) > -1) {\n                            Global.game.showPropDialog(1);\n                            gridControllerScript.popDialogTimes = currTime;\n                        }\n                    }\n                } else {\n                    var random = Math.random();\n                    if (gridControllerScript.popDialogTimes < Global.cdnGameConfig.popPropTotalTimes || random <= Global.cdnGameConfig.weightRate) {\n                        if (Global.cdnGameConfig.scoreEquals && Global.cdnGameConfig.scoreEquals.indexOf(self.gridNum) > -1) {\n                            Global.game.showPropDialog(1);\n                            gridControllerScript.popDialogTimes++;\n                        }\n                    }\n                }\n            }\n           \n            console.log('deleteGrids:' + self.deleteGrids.length);\n\n            console.log('addScore', self.gridNum);\n            gridControllerScript.scoreScript.addScore(self.gridNum + extraNum + doubleNum);\n            console.log('addScore end,self.item:', self.item);\n            if (self.item) {\n                var itemViewScript = self.item.getComponent('itemView');\n                itemViewScript.bornNum = self.gridNum;\n                console.log('updateNum');\n                itemViewScript.updateNum(-1);\n                console.log('updateColor');\n                itemViewScript.updateColor();\n                console.log('playFlyNum');\n                //飞入动画\n                self.playFlyNum();\n                console.log('playFlyGold');\n                //飞入金币\n                self.playFlyGold();\n                console.log('updateGold');\n                //gridControllerScript.updateGold(self.gridNum);\n            }\n        }\n    },\n\n    //开始播放飞入动画\n    playFlyNum: function () {\n        //合成一个512或者2048就播放数字向上飘的动画\n        var flyIndex = Global.canFlyNums.indexOf(parseInt(this.gridNum));\n        if (flyIndex <= -1) {\n            return;\n        }\n        // if (this.numInstance == null) {\n        this.numInstance = cc.instantiate(this.numPrefab);\n        // }\n        // if (this.numInstance.parent) {\n        //     this.numInstance.parent.removeChild(this.numInstance);\n        // }\n        this.numInstance.getComponent('flyNum').setNum(this.gridNum);\n        this.numInstance.setPosition(cc.p(this.node.getPosition().x, this.node.getPosition().y));\n        this.node.parent.addChild(this.numInstance);\n        this.numInstance.getComponent('flyNum').toPosition(-300);\n    },\n\n    //播放钻石动画\n    playFlyGold: function () {\n        //合成一个512或者2048就播放数字向上飘的动画\n        var flyIndex = Global.canFlyGolds.indexOf(parseInt(this.gridNum));\n        if (flyIndex <= -1) {\n            return;\n        }\n        this.goldInstance = cc.instantiate(this.goldPrefab);\n        this.goldInstance.setPosition(cc.p(this.node.getPosition().x, this.node.getPosition().y));\n        this.node.parent.addChild(this.goldInstance);\n        //金币飞入到gridControllder的金币位置\n        var gridControllerScript = Global.gridController.getComponent(\"gridController\");\n        this.goldInstance.getComponent('flyGold').toPosition(gridControllerScript.goldNode.getPosition(), this.gridNum);\n    },\n\n    //从当前的格子开始遍历\n    bianliForGrid: function () {\n        var gridViewScript = this.node.getComponent(\"gridView\");\n        //将要遍历格子的横向索引\n        var bianliHIndex = gridViewScript.hIndex;\n        //将要遍历格子的纵向索引\n        var bianliVIndex = gridViewScript.vIndex;\n\n        //遍历左边\n        this.hasSameScore(bianliHIndex - 1, bianliVIndex);\n        //遍历右边\n        this.hasSameScore(bianliHIndex + 1, bianliVIndex);\n        //遍历上边\n        this.hasSameScore(bianliHIndex, bianliVIndex - 1);\n        //遍历下边\n        this.hasSameScore(bianliHIndex, bianliVIndex + 1);\n    },\n\n    //判断是否有相同分数的格子,如果有就进行合并\n    hasSameScore: function (hIndex, vIndex) {\n        //判断是否是边界\n        if (hIndex < 0 || hIndex >= Global.hNum || vIndex < 0 || vIndex >= Global.vNum) {\n            return;\n        }\n\n        if (hIndex == this.hIndex && vIndex == this.vIndex) {\n            return;\n        }\n\n        var compareGrid = this.allGrids[hIndex][vIndex];\n        if (this.deleteGrids.indexOf(compareGrid) > -1) {\n            return;\n        }\n        var compareGridScript = compareGrid.getComponent(\"gridView\");\n\n        //判断是否有item\n        if (compareGrid && compareGridScript.item == null) {\n            return;\n        }\n        //判断是否是锤子道具\n        var compareItem = compareGridScript.item;\n        if (compareItem.getComponent(\"itemView\").useClear) {\n            console.log('匹配项是锤子道具111');\n            return;\n        }\n\n        //达到最大分数\n        if (compareGridScript.gridNum > Global.gridMaxScore) {\n            return;\n        }\n        if (compareGridScript.isJoin) {\n            return;\n        }\n        var gridScript = this.node.getComponent(\"gridView\");\n        if (gridScript.item && gridScript.item.getComponent(\"itemView\").useClear) {\n            console.log('当前项是锤子道具222');\n            return;\n        }\n        if (compareGridScript.gridNum == gridScript.gridNum) {\n            this.deleteGrids.push(compareGrid);\n            compareGridScript.isDown = false;\n            this.bianliForGrid(compareGrid);\n            compareGridScript.isJoin = true;\n        }\n    },\n\n    //开始合并动作    \n    startJoin: function () {\n        var self = this;\n        if (self.deleteGrids.length <= 0) {\n            return 0;\n        }\n\n        this.joinItems = [];\n        for (let index = 0; index < self.deleteGrids.length; index++) {\n            var deleteGrid = self.deleteGrids[index];\n            var deleteGridScript = deleteGrid.getComponent(\"gridView\");\n            //销毁的item\n            var deleteItem = deleteGridScript.item;\n            this.joinItems.push(deleteGridScript.item);\n\n            //判断被销毁对格子是否是加倍道具\n            if (deleteItem.useDouble) {\n                console.log('加倍道具1' + deleteGridScript.gridNum);\n                deleteItem.useDouble = false;\n                Global.usePropStatus = 2;\n            }\n            //判断自己格子是否是加倍道具\n            if (this.item.useDouble) {\n                console.log('加倍道具2' + this.gridNum);\n                this.item.useDouble = false;\n                Global.usePropStatus = 2;\n            }\n\n            deleteItem.toJoin(this.node.getPosition());\n\n            console.log('删除item：' + deleteGridScript.gridNum, deleteGridScript.hIndex, deleteGridScript.vIndex);\n            deleteGridScript.item = null;\n            deleteGridScript.resetData();\n        }\n        //播放合并的声音\n        this.actionJoin = true;\n        this.check();\n    },\n\n    check: function () {\n        let self = this;\n        this.node.runAction(cc.sequence(cc.delayTime(0.01), cc.callFunc(function () {\n            self.checkJoinComplete();\n        })));\n    },\n\n    checkJoinComplete: function () {\n        let isComplete = true;\n        for (let index = 0; index < this.joinItems.length; index++) {\n            var deleteItem = this.joinItems[index];\n            if (deleteItem.curState > 0) {\n                isComplete = false;\n                break;\n            }\n        }\n        if (isComplete) {\n            this.changeScore();\n            this.actionJoin = false;\n            this.playCombineAudio();\n        } else {\n            this.check();\n        }\n    },\n\n    playCombineAudio: function () {\n        cc.log('play audio');\n        if (Global.isBGMPlaying && this.combineAudio != null) {\n            this.combineID = cc.audioEngine.play(this.combineAudio, false, 1);\n            //回调\n            var self = this;\n            if (self.combineID > 0) {\n                cc.audioEngine.setFinishCallback(self.combineID, function () {\n                    self.playAudioEnd();\n                });\n            }\n        }\n    },\n    //播放声音\n    playAudioStart: function () {\n        if (this.combineID != 0) {\n            cc.audioEngine.resume(this.combineID);\n        }\n    },\n\n    //暂停声音声音\n    playAudioEnd: function () {\n        cc.audioEngine.uncache(this.combineID);\n    },\n\n    //重置数据\n    resetData: function () {\n        this.gridNum = 0;\n    },\n});"]}